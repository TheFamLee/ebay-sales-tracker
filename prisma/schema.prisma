generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String?
  role          String    @default("USER") // USER or ADMIN

  // 2FA fields
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret  String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  sales         Sale[]
  listings      Listing[]
  notifications Notification[]
  ebaySales     EbaySale[]
  ebayListings  EbayListing[]
  ebayPayouts   EbayPayout[]

  // Invite codes
  createdInvites InviteCode[] @relation("CreatedInvites")
  usedInvite     InviteCode?  @relation("UsedInvite")

  // eBay Auth
  ebayUserId       String?
  ebayUsername     String?
  ebayToken        String?   @db.Text
  ebayRefreshToken String?   @db.Text
  ebayTokenExpiry  DateTime?
  ebayConnectedAt  DateTime?
}

model Item {
  id          String   @id @default(cuid())
  itemNumber  String   @unique
  description String
  category    String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  sales       Sale[]
  listings    Listing[]
  priceHistory PriceHistory[]
}

model Sale {
  id            String   @id @default(cuid())

  userId        String
  user          User     @relation(fields: [userId], references: [id])

  itemId        String
  item          Item     @relation(fields: [itemId], references: [id])

  listedDate    DateTime?
  saleDate      DateTime
  listedPrice   Float
  salePrice     Float
  shippingCost  Float    @default(0)
  suppliesCost  Float    @default(0)
  netProfit     Float

  offerStartDate DateTime?
  offerExpirationDate DateTime?

  ebayOrderId   String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([itemId])
  @@index([saleDate])
}

model Listing {
  id            String   @id @default(cuid())

  userId        String
  user          User     @relation(fields: [userId], references: [id])

  itemId        String
  item          Item     @relation(fields: [itemId], references: [id])

  ebayListingId String?  @unique
  ebayUrl       String?

  currentPrice  Float
  listedDate    DateTime
  status        String   @default("ACTIVE") // ACTIVE, SOLD, ENDED

  views         Int?
  watchers      Int?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([itemId])
  @@index([status])
}

// eBay Sales from API - stores complete order data
model EbaySale {
  id              String   @id @default(cuid())

  userId          String
  user            User     @relation(fields: [userId], references: [id])

  // eBay identifiers
  orderId         String   @unique
  legacyOrderId   String?

  // Buyer info
  buyerUsername   String?

  // Item details
  itemId          String?  // eBay item ID
  title           String
  sku             String?
  quantity        Int      @default(1)

  // Pricing from eBay
  itemPrice       Float    // What item sold for
  shippingCost    Float    @default(0) // Shipping charged to buyer
  salesTax        Float    @default(0)
  ebayFees        Float    @default(0) // Final value fee + payment processing
  totalAmount     Float    // Total collected

  // User-entered costs (not from eBay)
  productCost     Float?   // What user paid for item
  shippingMaterialsCost Float? // Boxes, tape, etc.
  actualShippingCost Float?   // If different from eBay label
  otherCosts      Float?   // Mileage, etc.
  costNotes       String?  // Notes about costs

  // Calculated
  netProfit       Float?   // Calculated after user enters costs

  // Dates
  orderDate       DateTime
  paidDate        DateTime?
  shippedDate     DateTime?

  // Status
  orderStatus     String   // PENDING, PAID, SHIPPED, DELIVERED, CANCELLED

  // Shipping
  trackingNumber  String?
  shippingCarrier String?

  // Raw data backup
  rawOrderData    String?  @db.Text // JSON of full order from eBay

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([orderDate])
  @@index([orderStatus])
}

// eBay Active Listings from API
model EbayListing {
  id              String   @id @default(cuid())

  userId          String
  user            User     @relation(fields: [userId], references: [id])

  // eBay identifiers
  listingId       String   @unique // eBay listing/item ID

  // Listing details
  title           String
  sku             String?

  // Pricing
  currentPrice    Float
  originalPrice   Float?

  // Quantity
  quantityAvailable Int     @default(1)
  quantitySold      Int     @default(0)

  // Performance
  viewCount       Int?
  watchCount      Int?

  // Dates
  startDate       DateTime
  endDate         DateTime?

  // Status
  status          String   @default("ACTIVE") // ACTIVE, ENDED, SOLD

  // Images
  imageUrl        String?
  ebayUrl         String?

  // User costs for this item
  productCost     Float?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

// eBay Payouts/Transactions
model EbayPayout {
  id              String   @id @default(cuid())

  userId          String
  user            User     @relation(fields: [userId], references: [id])

  payoutId        String   @unique

  amount          Float
  payoutDate      DateTime
  payoutStatus    String   // PENDING, COMPLETED, FAILED

  // Bank info (masked)
  bankAccountLast4 String?

  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([payoutDate])
}

model CompetitorPrice {
  id            String   @id @default(cuid())

  itemNumber    String
  source        String   // EBAY, AMAZON

  price         Float
  condition     String?
  url           String?
  title         String?

  scrapedAt     DateTime @default(now())

  @@index([itemNumber])
  @@index([scrapedAt])
}

model PriceHistory {
  id        String   @id @default(cuid())

  itemId    String
  item      Item     @relation(fields: [itemId], references: [id])

  price     Float
  priceType String   // LISTED, SOLD, COMPETITOR
  source    String?  // EBAY, AMAZON, USER

  date      DateTime @default(now())

  @@index([itemId])
  @@index([date])
}

model Notification {
  id        String   @id @default(cuid())

  userId    String
  user      User     @relation(fields: [userId], references: [id])

  type      String   // UNSOLD_ITEM, PRICE_CHANGE, SYSTEM
  title     String
  message   String

  read      Boolean  @default(false)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([read])
}

// Items to Sell - inventory not yet listed
model InventoryItem {
  id              String   @id @default(cuid())

  itemNumber      String?
  description     String
  minimumPrice    Float?
  cost            Float?
  status          String   @default("AVAILABLE") // AVAILABLE, LISTED, SOLD

  dateAdded       DateTime @default(now())

  userId          String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([status])
}

// USB Deposit tracking
model Deposit {
  id          String   @id @default(cuid())

  soldDate    DateTime
  description String
  total       Float
  netProfit   Float?

  userId      String?

  createdAt   DateTime @default(now())

  @@index([soldDate])
}

// Invite codes for registration
model InviteCode {
  id          String   @id @default(cuid())
  code        String   @unique

  createdById String
  createdBy   User     @relation("CreatedInvites", fields: [createdById], references: [id])

  usedById    String?  @unique
  usedBy      User?    @relation("UsedInvite", fields: [usedById], references: [id])

  maxUses     Int      @default(1)
  uses        Int      @default(0)

  expiresAt   DateTime?
  createdAt   DateTime @default(now())

  @@index([code])
}
